# MySQL – Viste e Accessi

## 1. Viste in MySQL

### Cos'è una vista?
Una **vista** è una **tabella virtuale** che non contiene dati propri, ma li ricava da una o più tabelle reali (dette di base).  
È definita tramite una query SQL.

### Sintassi:
```sql
CREATE VIEW NomeVista [(ListaAttributi)] AS SELECT ... 
[WITH [LOCAL | CASCADED] CHECK OPTION];
```

- La query deve restituire lo stesso numero e ordine di attributi della vista.
- Non sono ammesse **dipendenze ricorsive** (una vista che richiama se stessa).

### Esempio:
```sql
CREATE VIEW ImpiegatiAmmin (Matricola, Nome, Cognome, Stipendio) AS
SELECT Matricola, Nome, Cognome, Stipendio
FROM Impiegato
WHERE Dipart = 'Amministrazione' AND Stipendio > 10;
```

### Aggiornabilità:
- Le viste possono essere **modificabili** solo in certi casi:
  - Devono derivare da una **sola tabella**.
  - È preferibile che contengano una **chiave primaria**.
  - Se sono costruite con `JOIN`, le modifiche non sono permesse.

---

## 2. Vantaggi e Svantaggi delle Viste

### ✅ Vantaggi:
1. **Non occupano spazio fisico.**
2. **Sicurezza**: si possono escludere colonne sensibili.
3. **Comodità**: semplificano le query e migliorano la **leggibilità e performance**.

### ❌ Svantaggi:
1. **Modifiche rischiose**: UPDATE e DELETE possono causare errori o **inconsistenze**.
2. **Difficoltà di mantenimento**: specialmente in contesti complessi.

---

## 3. Interrogazioni e Aggiornamenti sulle Viste

Le viste si usano come normali tabelle:
```sql
SELECT * FROM ImpiegatiAmmin;
```

**Con `WITH CHECK OPTION`** si garantisce che i dati modificati **rimangano compatibili** con la definizione della vista:
```sql
CREATE VIEW ImpiegatiAmminPoveri AS
SELECT * FROM ImpiegatiAmmin
WHERE Stipendio < 50
WITH CHECK OPTION;
```

Esempio di update **non valido**:
```sql
UPDATE ImpiegatiAmminPoveri
SET Stipendio = 60
WHERE Nome = 'Paola';
```

---

## 4. Esempi di Interrogazioni Complesse con le Viste

### Problema:
```sql
SELECT AVG(COUNT(DISTINCT Ufficio))
FROM Impiegato
GROUP BY Dipart;
```
❌ Non valido.

### Soluzione con vista:
```sql
CREATE VIEW DipartUffici(NomeDip, NroUffici) AS
SELECT Dipart, COUNT(DISTINCT Ufficio)
FROM Impiegato
GROUP BY Dipart;

SELECT AVG(CAST(NroUffici AS DECIMAL(5,2))) AS NumeroMedioUffici
FROM DipartUffici;
```

---

## 5. Viste Ricorsive (MySQL 8+)

Usate per strutture gerarchiche (es. **alberi genealogici**).

### Dato:
```sql
Paternita(Padre, Figlio)
```

### Obiettivo:
Trovare tutti gli antenati (viste ricorsive).

```sql
WITH RECURSIVE Discendenza(Antenato, Discendente) AS (
  SELECT Padre, Figlio FROM Paternita
  UNION ALL
  SELECT D.Antenato, P.Figlio
  FROM Discendenza D, Paternita P
  WHERE D.Discendente = P.Padre
)
SELECT * FROM Discendenza;
```

---

## 6. Funzioni Scalari

Restituiscono **un valore per ogni riga** (ennupla).

### Tipologie:
- **Temporali**: `CURRENT_DATE`, `EXTRACT(YEAR FROM ...)`
- **Stringhe**: `CHAR_LENGTH()`, `LOWER()`
- **Conversioni**: `CAST()`

---

## 7. Funzioni Condizionali

### NULLIF():
```sql
SELECT NULLIF(25, 26);  -- → 25
SELECT NULLIF(25, 25);  -- → NULL
```

### COALESCE():
```sql
SELECT Nome, Cognome, COALESCE(Dipart, 'Ignoto')
FROM Impiegato;
```

### CASE:
```sql
SELECT Targa,
  CASE Tipo
    WHEN 'Auto' THEN 2.58 * KWatt
    WHEN 'Moto' THEN 22.00 + 1.00 * KWatt
    ELSE NULL
  END AS Tassa
FROM Veicolo
WHERE Anno > 1975;
```

---

## 8. Controllo degli Accessi in MySQL

- Utenti possono essere locali o definiti dal sistema.
- I privilegi sono associati a:
  - Risorsa (tabella, attributo...)
  - Utente che **concede** e **riceve**
  - Azione permessa
  - Possibilità di trasferire il privilegio

### Comandi principali:
```sql
CREATE USER ..., GRANT ..., REVOKE ...;
```

---

## 9. Ruoli

Un **ruolo** è un insieme di privilegi, utile per assegnare autorizzazioni a gruppi.

```sql
CREATE ROLE nome_ruolo;
DROP ROLE nome_ruolo;
```

---

## 10. Privilegi e Sicurezza

### Tipi di privilegi:
- `SELECT`, `INSERT`, `UPDATE`, `DELETE`
- `REFERENCES`, `USAGE`, `DROP`, `ALTER`

### Esempi:
```sql
GRANT SELECT ON Dipartimento TO Stefano;
REVOKE SELECT ON Dipartimento FROM Stefano;
```

### Miglior pratica:
Creare viste con solo le colonne necessarie, per **limitare l’accesso** senza complicare la gestione dei privilegi.
